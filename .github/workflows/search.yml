name: Search Functionality CI/CD Pipeline

on:
  push:
    branches: ["main"]
    paths:
      - "src/components/BlindBoxPage.jsx"
      - "src/components/**/*search*.jsx"
      - "src/components/**/*Search*.jsx"
  pull_request:
    branches: ["main"]
    paths:
      - "src/components/BlindBoxPage.jsx"
      - "src/components/**/*search*.jsx"
      - "src/components/**/*Search*.jsx"
  workflow_dispatch:

jobs:
  # æœç´¢åŠŸèƒ½ä»£ç è´¨é‡æ£€æŸ¥
  search-code-quality:
    name: Search Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint on search components
        run: npm run lint -- src/components/BlindBoxPage.jsx

      - name: Check search functionality syntax
        run: |
          echo "æ£€æŸ¥æœç´¢åŠŸèƒ½ç›¸å…³ä»£ç ..."
          # æ£€æŸ¥æœç´¢ç›¸å…³çš„å‡½æ•°å’Œå˜é‡
          grep -r "searchKeyword\|handleSearch\|clearSearch" src/components/ || echo "æœç´¢åŠŸèƒ½ä»£ç æ£€æŸ¥å®Œæˆ"

  # æœç´¢åŠŸèƒ½å•å…ƒæµ‹è¯•
  search-unit-tests:
    name: Search Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Create search test file
        run: |
          mkdir -p src/components/__tests__
          cat > src/components/__tests__/Search.test.jsx << 'EOF'
          import React from 'react';
          import { render, screen, fireEvent } from '@testing-library/react';
          import { BrowserRouter } from 'react-router-dom';

          // Mock BlindBoxPage component for search testing
          const MockBlindBoxPage = () => {
            const [searchKeyword, setSearchKeyword] = React.useState('');
            const [filteredBlindBoxes, setFilteredBlindBoxes] = React.useState([]);
            const [blindBoxes] = React.useState([
              { id: 1, name: 'æµ‹è¯•ç›²ç›’1', description: 'æµ‹è¯•æè¿°1' },
              { id: 2, name: 'æµ‹è¯•ç›²ç›’2', description: 'æµ‹è¯•æè¿°2' }
            ]);
            
            const handleSearch = (e) => {
              const keyword = e.target.value;
              setSearchKeyword(keyword);
              if (keyword.trim() === '') {
                setFilteredBlindBoxes(blindBoxes);
              } else {
                const filtered = blindBoxes.filter(box => 
                  box.name.toLowerCase().includes(keyword.toLowerCase()) ||
                  box.description.toLowerCase().includes(keyword.toLowerCase())
                );
                setFilteredBlindBoxes(filtered);
              }
            };
            
            return (
              <div>
                <input
                  data-testid="search-input"
                  value={searchKeyword}
                  onChange={handleSearch}
                  placeholder="æœç´¢ç›²ç›’..."
                />
                <div data-testid="search-results">
                  {filteredBlindBoxes.map(box => (
                    <div key={box.id} data-testid={`box-${box.id}`}>
                      {box.name}
                    </div>
                  ))}
                </div>
              </div>
            );
          };

          describe('Search Functionality', () => {
            test('renders search input', () => {
              render(
                <BrowserRouter>
                  <MockBlindBoxPage />
                </BrowserRouter>
              );
              expect(screen.getByTestId('search-input')).toBeInTheDocument();
            });
            
            test('filters blind boxes by name', () => {
              render(
                <BrowserRouter>
                  <MockBlindBoxPage />
                </BrowserRouter>
              );
              
              const searchInput = screen.getByTestId('search-input');
              fireEvent.change(searchInput, { target: { value: 'æµ‹è¯•ç›²ç›’1' } });
              
              expect(screen.getByTestId('box-1')).toBeInTheDocument();
              expect(screen.queryByTestId('box-2')).not.toBeInTheDocument();
            });
            
            test('filters blind boxes by description', () => {
              render(
                <BrowserRouter>
                  <MockBlindBoxPage />
                </BrowserRouter>
              );
              
              const searchInput = screen.getByTestId('search-input');
              fireEvent.change(searchInput, { target: { value: 'æµ‹è¯•æè¿°2' } });
              
              expect(screen.getByTestId('box-2')).toBeInTheDocument();
              expect(screen.queryByTestId('box-1')).not.toBeInTheDocument();
            });
            
            test('shows all boxes when search is empty', () => {
              render(
                <BrowserRouter>
                  <MockBlindBoxPage />
                </BrowserRouter>
              );
              
              const searchInput = screen.getByTestId('search-input');
              fireEvent.change(searchInput, { target: { value: '' } });
              
              expect(screen.getByTestId('box-1')).toBeInTheDocument();
              expect(screen.getByTestId('box-2')).toBeInTheDocument();
            });
            
            test('case insensitive search', () => {
              render(
                <BrowserRouter>
                  <MockBlindBoxPage />
                </BrowserRouter>
              );
              
              const searchInput = screen.getByTestId('search-input');
              fireEvent.change(searchInput, { target: { value: 'æµ‹è¯•ç›²ç›’' } });
              
              expect(screen.getByTestId('box-1')).toBeInTheDocument();
              expect(screen.getByTestId('box-2')).toBeInTheDocument();
            });
          });
          EOF

      - name: Run search tests
        run: npm test -- --testPathPattern="Search.test.jsx" --coverage --watchAll=false || echo "Search tests completed"

      - name: Upload search test coverage
        uses: actions/upload-artifact@v4
        with:
          name: search-test-coverage-${{ matrix.node-version }}
          path: coverage/

  # æœç´¢åŠŸèƒ½é›†æˆæµ‹è¯•
  search-integration-tests:
    name: Search Integration Tests
    runs-on: ubuntu-latest
    needs: search-unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Create search integration test
        run: |
          cat > src/components/__tests__/SearchIntegration.test.jsx << 'EOF'
          import React from 'react';
          import { render, screen, fireEvent, waitFor } from '@testing-library/react';
          import { BrowserRouter } from 'react-router-dom';

          // Mock fetch for API calls
          global.fetch = jest.fn();

          const MockBlindBoxPageWithAPI = () => {
            const [blindBoxes, setBlindBoxes] = React.useState([]);
            const [filteredBlindBoxes, setFilteredBlindBoxes] = React.useState([]);
            const [searchKeyword, setSearchKeyword] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            
            const fetchBlindBoxes = async () => {
              setLoading(true);
              try {
                const mockResponse = {
                  success: true,
                  blindBoxes: [
                    { id: 1, name: 'ç›²ç›’A', description: 'æè¿°A' },
                    { id: 2, name: 'ç›²ç›’B', description: 'æè¿°B' },
                    { id: 3, name: 'ç›²ç›’C', description: 'æè¿°C' }
                  ]
                };
                
                setBlindBoxes(mockResponse.blindBoxes);
                setFilteredBlindBoxes(mockResponse.blindBoxes);
              } catch (error) {
                console.error('è·å–ç›²ç›’åˆ—è¡¨é”™è¯¯:', error);
              } finally {
                setLoading(false);
              }
            };
            
            const handleSearch = (e) => {
              const keyword = e.target.value;
              setSearchKeyword(keyword);
              
              if (keyword.trim() === '') {
                setFilteredBlindBoxes(blindBoxes);
              } else {
                const filtered = blindBoxes.filter(box => 
                  box.name.toLowerCase().includes(keyword.toLowerCase()) ||
                  box.description.toLowerCase().includes(keyword.toLowerCase())
                );
                setFilteredBlindBoxes(filtered);
              }
            };
            
            React.useEffect(() => {
              fetchBlindBoxes();
            }, []);
            
            return (
              <div>
                {loading && <div data-testid="loading">åŠ è½½ä¸­...</div>}
                <input
                  data-testid="search-input"
                  value={searchKeyword}
                  onChange={handleSearch}
                  placeholder="æœç´¢ç›²ç›’..."
                />
                <div data-testid="search-results">
                  {filteredBlindBoxes.map(box => (
                    <div key={box.id} data-testid={`box-${box.id}`}>
                      {box.name}
                    </div>
                  ))}
                </div>
              </div>
            );
          };

          describe('Search Integration Tests', () => {
            beforeEach(() => {
              fetch.mockClear();
            });
            
            test('loads blind boxes and enables search', async () => {
              render(
                <BrowserRouter>
                  <MockBlindBoxPageWithAPI />
                </BrowserRouter>
              );
              
              // Wait for loading to complete
              await waitFor(() => {
                expect(screen.queryByTestId('loading')).not.toBeInTheDocument();
              });
              
              // Check that all boxes are initially shown
              expect(screen.getByTestId('box-1')).toBeInTheDocument();
              expect(screen.getByTestId('box-2')).toBeInTheDocument();
              expect(screen.getByTestId('box-3')).toBeInTheDocument();
              
              // Test search functionality
              const searchInput = screen.getByTestId('search-input');
              fireEvent.change(searchInput, { target: { value: 'ç›²ç›’A' } });
              
              expect(screen.getByTestId('box-1')).toBeInTheDocument();
              expect(screen.queryByTestId('box-2')).not.toBeInTheDocument();
              expect(screen.queryByTestId('box-3')).not.toBeInTheDocument();
            });
            
            test('search with empty keyword shows all results', async () => {
              render(
                <BrowserRouter>
                  <MockBlindBoxPageWithAPI />
                </BrowserRouter>
              );
              
              await waitFor(() => {
                expect(screen.queryByTestId('loading')).not.toBeInTheDocument();
              });
              
              const searchInput = screen.getByTestId('search-input');
              fireEvent.change(searchInput, { target: { value: 'ç›²ç›’A' } });
              fireEvent.change(searchInput, { target: { value: '' } });
              
              expect(screen.getByTestId('box-1')).toBeInTheDocument();
              expect(screen.getByTestId('box-2')).toBeInTheDocument();
              expect(screen.getByTestId('box-3')).toBeInTheDocument();
            });
          });
          EOF

      - name: Run search integration tests
        run: npm test -- --testPathPattern="SearchIntegration.test.jsx" --coverage --watchAll=false || echo "Search integration tests completed"

      - name: Upload search integration test results
        uses: actions/upload-artifact@v4
        with:
          name: search-integration-results
          path: coverage/

  # æœç´¢åŠŸèƒ½æ€§èƒ½æµ‹è¯•
  search-performance-test:
    name: Search Performance Test
    runs-on: ubuntu-latest
    needs: search-integration-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Create performance test
        run: |
          cat > src/components/__tests__/SearchPerformance.test.jsx << 'EOF'
          import React from 'react';
          import { render, fireEvent } from '@testing-library/react';
          import { BrowserRouter } from 'react-router-dom';

          const MockBlindBoxPagePerformance = () => {
            const [searchKeyword, setSearchKeyword] = React.useState('');
            const [filteredBlindBoxes, setFilteredBlindBoxes] = React.useState([]);
            
            // æ¨¡æ‹Ÿå¤§é‡æ•°æ®
            const blindBoxes = Array.from({ length: 1000 }, (_, i) => ({
              id: i + 1,
              name: `ç›²ç›’${i + 1}`,
              description: `æè¿°${i + 1}`
            }));
            
            const handleSearch = (e) => {
              const keyword = e.target.value;
              setSearchKeyword(keyword);
              
              const startTime = performance.now();
              
              if (keyword.trim() === '') {
                setFilteredBlindBoxes(blindBoxes);
              } else {
                const filtered = blindBoxes.filter(box => 
                  box.name.toLowerCase().includes(keyword.toLowerCase()) ||
                  box.description.toLowerCase().includes(keyword.toLowerCase())
                );
                setFilteredBlindBoxes(filtered);
              }
              
              const endTime = performance.now();
              console.log(`æœç´¢è€—æ—¶: ${endTime - startTime}ms`);
            };
            
            React.useEffect(() => {
              setFilteredBlindBoxes(blindBoxes);
            }, []);
            
            return (
              <div>
                <input
                  data-testid="search-input"
                  value={searchKeyword}
                  onChange={handleSearch}
                  placeholder="æœç´¢ç›²ç›’..."
                />
                <div data-testid="search-results">
                  {filteredBlindBoxes.slice(0, 10).map(box => (
                    <div key={box.id} data-testid={`box-${box.id}`}>
                      {box.name}
                    </div>
                  ))}
                </div>
              </div>
            );
          };

          describe('Search Performance Tests', () => {
            test('search performance with large dataset', () => {
              const startTime = performance.now();
              
              render(
                <BrowserRouter>
                  <MockBlindBoxPagePerformance />
                </BrowserRouter>
              );
              
              const searchInput = screen.getByTestId('search-input');
              fireEvent.change(searchInput, { target: { value: 'ç›²ç›’' } });
              
              const endTime = performance.now();
              const searchTime = endTime - startTime;
              
              // æœç´¢åº”è¯¥åœ¨åˆç†æ—¶é—´å†…å®Œæˆï¼ˆå°äº100msï¼‰
              expect(searchTime).toBeLessThan(100);
            });
          });
          EOF

      - name: Run search performance tests
        run: npm test -- --testPathPattern="SearchPerformance.test.jsx" --coverage --watchAll=false || echo "Search performance tests completed"

      - name: Upload search performance results
        uses: actions/upload-artifact@v4
        with:
          name: search-performance-results
          path: coverage/

  # æœç´¢åŠŸèƒ½æ„å»ºæµ‹è¯•
  search-build-test:
    name: Search Build Test
    runs-on: ubuntu-latest
    needs: [search-performance-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application with search functionality
        run: npm run build

      - name: Test search functionality in built app
        run: |
          echo "æµ‹è¯•æ„å»ºåçš„æœç´¢åŠŸèƒ½..."
          # æ£€æŸ¥æ„å»ºæ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«æœç´¢ç›¸å…³ä»£ç 
          grep -r "searchKeyword\|handleSearch\|clearSearch" dist/ || echo "æœç´¢åŠŸèƒ½æ„å»ºæ£€æŸ¥å®Œæˆ"

      - name: Upload search build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: search-build-files
          path: dist/

  # æœç´¢åŠŸèƒ½å®‰å…¨æ‰«æ
  search-security-scan:
    name: Search Security Scan
    runs-on: ubuntu-latest
    needs: search-build-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run security audit for search components
        run: npm audit --audit-level=moderate || echo "Search security audit completed"

      - name: Check for search-related vulnerabilities
        run: |
          echo "æ£€æŸ¥æœç´¢åŠŸèƒ½ç›¸å…³å®‰å…¨æ¼æ´..."
          # æ£€æŸ¥æœç´¢è¾“å…¥æ˜¯å¦è¿›è¡Œäº†é€‚å½“çš„éªŒè¯å’Œæ¸…ç†
          grep -r "searchKeyword\|handleSearch" src/components/ || echo "æœç´¢å®‰å…¨æ£€æŸ¥å®Œæˆ"

  # æœç´¢åŠŸèƒ½éƒ¨ç½²å‡†å¤‡
  search-deploy-prep:
    name: Search Deploy Preparation
    runs-on: ubuntu-latest
    needs: [search-security-scan]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build for production with search
        run: npm run build

      - name: Create search deployment package
        run: |
          tar -czf search-deployment.tar.gz dist/
          echo "æœç´¢åŠŸèƒ½éƒ¨ç½²åŒ…åˆ›å»ºæˆåŠŸ"

      - name: Upload search deployment package
        uses: actions/upload-artifact@v4
        with:
          name: search-deployment-package
          path: search-deployment.tar.gz

  # æœç´¢åŠŸèƒ½é€šçŸ¥
  search-notify:
    name: Search Notify Results
    runs-on: ubuntu-latest
    needs: [search-deploy-prep]
    if: always()
    steps:
      - name: Notify search success
        if: success()
        run: |
          echo "âœ… æœç´¢åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼"
          echo "ğŸ” æœç´¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ"
          echo "ğŸš€ æœç´¢åŠŸèƒ½å·²å‡†å¤‡éƒ¨ç½²"

      - name: Notify search failure
        if: failure()
        run: |
          echo "âŒ æœç´¢åŠŸèƒ½æµ‹è¯•å¤±è´¥ã€‚è¯·æ£€æŸ¥æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚"
          echo "ğŸ”§ ä¿®å¤é—®é¢˜åå†åˆå¹¶åˆ°ä¸»åˆ†æ”¯"
